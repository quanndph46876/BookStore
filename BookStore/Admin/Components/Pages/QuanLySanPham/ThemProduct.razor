@page "/product"
@layout Layout.MainLayout
@using API.Models.DTO
@using AutoMapper
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@inject Service.IService.IProductService monAnService 
@inject Service.IService.IApiService apiService
@inject Service.IService.IUploadService UploadService
@inject XulyId xulyId
@inject IMapper _mapper

<link href="css/ThemMonAn.css" rel="stylesheet" />
<div class="container">
    <div class="header">
        <button class="back-btn" @onclick="GoBack">
            <i class="fas fa-arrow-left"></i> Quay lại
        </button>
        <h1> Thêm sản phẩm</h1>
    </div>

    <div class="form-container">
        @if (showSuccessMessage)
        {
            <div class="success-message">@successMessage</div>
        }

        <EditForm Model="@model" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />

            <!-- Thông tin cơ bản sản phẩm -->
            <div class="form-section">
                <h3>📋 Thông tin sản phẩm</h3>

                <div class="form-group">
                    <label>Tên sản phẩm</label>
                    <InputText @bind-Value="model.MonAn.Ten" @oninput="OnTenChanged" />
                </div>
                <div class="form-group">
                    <div>
                        <label for="theloai">Tác giả</label>
                        <div class="select-with-add row-layout ">

                            <InputSelect id="loaivi" @bind-Value="model.MonAn.TacGiaId">
                                <option selected value="@Guid.Empty">-- Tác giả --</option>
                                @foreach (var item in theLoaisList)
                                {
                                    <option value="@item.Id">@item.Ten</option>
                                }
                            </InputSelect>
                            <button type="button" class="btn-add" @onclick='() => ShowModal("TacGia")'>+</button>
                        </div>
                    </div>
                    <div>
                        <label for="thuonghieu">Nhà Xuất Bản</label>
                        <div class="select-with-add row-layout ">

                            <InputSelect id="thuonghieu" @bind-Value="model.MonAn.NhaXuatBanId">
                                <option selected value="@Guid.Empty">-- Nhà Xuất Bản --</option>
                                @foreach (var item in thuongHieusList)
                                {
                                    <option value="@item.Id">@item.Ten</option>
                                }
                            </InputSelect>
                            <button type="button" class="btn-add" @onclick='() => ShowModal("NhaXuatBan")'>+</button>
                        </div>

                    </div>
                </div>
                <div class="form-group">
                    <label>Mô tả</label>
                    <InputTextArea @bind-Value="model.MonAn.Mota" rows="3" />
                </div>
            </div>

            <!-- Sử dụng component chi tiết sản phẩm -->
            <ThemChiTietProduct
                DanhSachChiTiet="@model.DanhSachChiTiet"
                MonAnId="@model.MonAn.Id"
                ButtonText="+ Tạm thêm"
                ShowFileUpload="true"
                ShowDescription="false"
                ShowStatus="false"
                ShowCancelButton="false"
                AllowEditInTable="true"
                OnThemChiTiet="OnChiTietAdded"
                OnXoaChiTiet="OnChiTietRemoved"
                OnSuaChiTiet="OnChiTietEdited" 
                />

            <div class="form-actions">
                <button type="submit" @onclick="() => submitcheck = true" class="btn btn-primary">✅ Thêm sản phẩm và toàn bộ chi tiết</button>
                <button type="button" class="btn btn-secondary" @onclick="ResetForm">🔄 Làm mới</button>
            </div>
        </EditForm>
    </div>
</div>
@if (showModal)
{
    <div class="modal-overlay">
        <div class="modal-box">
            <h4>Thêm mới @modalType</h4>
            @if (showSuccessMessage)
            {
                <div class="success-message">@successMessage</div>
            }
            <div class="form-group">
                <label>Tên</label>
                <InputText @bind-Value="newItemTen" class="form-control" />
            </div>
            <div class="form-group">
                <label>Mô tả</label>
                <InputTextArea @bind-Value="newItemMota" class="form-control" rows="3" />
            </div>
            <div class="text-end">
                <button class="btn btn-secondary" @onclick="CloseModal">Hủy</button>
                <button class="btn btn-primary" @onclick="ConfirmAddNewItem">Thêm</button>
            </div>
        </div>
    </div>
}
@code {
    private MonAnFormModel model = new();
    private bool showSuccessMessage = false;
    private string successMessage = "";
    private bool submitcheck = false;
    private int hanSuDung = 0;
    private string modalType = "";
    private string newItemTen = "";
    private string newItemMota = "";
    private bool showModal = false;

    public class MonAnFormModel
    {
        public Product MonAn { get; set; } = new();
        public List<ChiTietProductDTO> DanhSachChiTiet { get; set; } = new();
    }


    protected override async Task OnInitializedAsync()
    {
        model.MonAn.Id = await monAnService.GetIdMonAn();
        await LoadDropdownData();
    }
    private void ShowModal(string type)
    {
        modalType = type;
        newItemTen = "";
        newItemMota = "";
        showModal = true;
    }
    private async Task HandleValidSubmit()
    {
        try
        {
            if (submitcheck)
            {

                var monAnResponse = await apiService.PostAsync<Product, Product>("Product", model.MonAn);
                if (monAnResponse == null)
                {

                    successMessage = "❌ Lỗi khi thêm sản phẩm.";
                    showSuccessMessage = true;
                    submitcheck = false;
                    return;

                }
                foreach (var ct in model.DanhSachChiTiet)
                {
                    ct.ProductId = monAnResponse.Id;

                    var result1 = await apiService.PostAsync<API.Models.ChiTietProduct, API.Models.ChiTietProduct>("ChiTietProduct", _mapper.Map<API.Models.ChiTietProduct>(ct));
                    if (ct.DanhSachAnh != null)
                    {
                        foreach (var item in ct.DanhSachAnh)
                        {
                            try
                            {
                                item.ChiTietMonAnId = result1.Id;
                                var result = await apiService.PostAsync<Anh, Anh>("Anh", _mapper.Map<Anh>(item));
                                if (result == null)
                                {
                                    continue;
                                }
                            }
                            catch (Exception)
                            {
                                continue;
                            }

                        }
                    }
                }
                Navigation.NavigateTo("/quanlysanpham");
                successMessage = "✅ Đã thêm sản phẩm và các chi tiết thành công.";
                showSuccessMessage = true;
                await ResetForm();
            }
        }
        catch (Exception ex)
        {
            successMessage = $"❌ Lỗi: {ex.Message}";
            showSuccessMessage = true;
        }
    }
    private void CloseModal()
    {
        showModal = false;
        modalType = "";
    }
    private List<TheLoai> theLoaisList = new();
    private List<NhaXuatBan> thuongHieusList = new();
    private async Task LoadDropdownData()
    {
        theLoaisList = await apiService.GetAsync<List<TheLoai>>("TheLoai") ?? new();
        thuongHieusList = await apiService.GetAsync<List<NhaXuatBan>>("NhaXuatBan") ?? new();
        StateHasChanged();
    }
    private async Task ConfirmAddNewItem()
    {
        if (string.IsNullOrWhiteSpace(newItemTen))
        {
            successMessage = $"❌ Lỗi khi thêm {modalType}";
            showSuccessMessage = true;
            return;
        }
        var id = Guid.NewGuid();

        switch (modalType)
        {
            case "TacGia":
                var newLoaiVi = new TacGia { Id = id, Ten = newItemTen, Mota = newItemMota };
                await apiService.PostAsync<TacGia, TacGia>("TacGia", newLoaiVi);
                await LoadDropdownData();
                break;
            case "NhaXuatBan":
                var newKichCo = new NhaXuatBan { Id = id, Ten = newItemTen, Mota = newItemMota };
                await apiService.PostAsync<NhaXuatBan, NhaXuatBan>("NhaXuatBan", newKichCo);
                await LoadDropdownData();
                break;
        }

        CloseModal();
    }
    private async Task ResetForm()
    {
        model = new MonAnFormModel();
        await OnInitializedAsync();
        StateHasChanged();
    }

    private void OnTenChanged(ChangeEventArgs e)
    {
        var ten = e.Value?.ToString() ?? "";
        if (!string.IsNullOrEmpty(ten))
        {
            var id = ten.ToLower().Replace(" ", "").Replace("đ", "d").Replace("ă", "a").Replace("â", "a").Replace("ê", "e").Replace("ô", "o").Replace("ơ", "o").Replace("ư", "u");
            model.MonAn.Id = System.Text.RegularExpressions.Regex.Replace(id, @"[^a-z0-9]", "");
        }
    }

    
    private async Task OnChiTietAdded(ChiTietProductDTO chiTiet)
    {
        
        Console.WriteLine($"Đã thêm chi tiết: {chiTiet.Id}");
    }

    private async Task OnChiTietRemoved(ChiTietProductDTO chiTiet)
    {
        
        Console.WriteLine($"Đã xóa chi tiết: {chiTiet.Id}");
    }

    private async Task OnChiTietEdited(ChiTietProductDTO chiTiet)
    {
        
        Console.WriteLine($"Đã sửa chi tiết: {chiTiet.Id}");
    }
    private void GoBack()
    {
        Navigation.NavigateTo("/quanlysanpham", forceLoad: false);
    }
}