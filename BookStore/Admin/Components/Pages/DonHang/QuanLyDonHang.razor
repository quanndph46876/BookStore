@page "/hoadon"
@layout Layout.MainLayout
@inject IHoaDonChiTietService ChiTietHoaDonService
@inject IChiTietProductService GetChiTietMonAnService
@inject IHoaDonService HoaDonService
@inject IApiService ApiService
@inject IJSRuntime JS

<link href="css/HoaDon.css" rel="stylesheet" />

<h2 class="text-xl font-semibold mb-4">Quản lý đơn hàng</h2>


<div class="search-row">
    <input @bind="TuKhoa" @bind:event="oninput" placeholder="Tìm kiếm..." />
    <button @onclick="TaiLai">Tải lại</button>
</div>


<div class="tabs">
    @foreach (var trangThaiItem in TrangThaiList)
    {
        <button class="@(TrangThai == trangThaiItem ? "active" : "")"
                @onclick='() => LocTheoTrangThai(trangThaiItem)'>
            @trangThaiItem
        </button>
    }
</div>


<table class="table-auto w-full text-sm">
    <thead>
        <tr class="bg-gray-100">
            <th class="p-2">#</th>
            <th class="p-2">Mã đơn</th>
            <th class="p-2">Tổng SP</th>
            <th class="p-2">Tổng tiền</th>
            <th class="p-2">Khách hàng</th>
            <th class="p-2">Ngày tạo</th>
            <th class="p-2">Loại</th>
            <th class="p-2">Trạng thái</th>
            <th class="p-2">Hành động</th>
        </tr>
    </thead>
    <tbody>
        @if (DanhSachHoaDon?.Any() == true)
        {
            var stt = 1;
            foreach (var hoaDon in DanhSachHoaDon)
            {
                var chiTiets = ChiTietTheoHoaDon.GetValueOrDefault(hoaDon.Id);
                var tongSoSP = chiTiets?.Sum(c => c.Soluong) ?? 0;

                <tr class="border-b">
                    <td class="p-2">@stt</td>
                    <td class="p-2">@hoaDon.Id</td>
                    <td class="p-2">@tongSoSP</td>
                    <td class="p-2">@hoaDon.TongTien.ToString("N0") đ</td>
                    <td class="p-2">@(string.IsNullOrWhiteSpace(hoaDon.KhachHang?.NguoiDung?.Ten) ? "Khách lẻ" : hoaDon.KhachHang.NguoiDung.Ten)</td>
                    <td class="p-2">@hoaDon.NgayTao.ToString("dd/MM/yyyy HH:mm")</td>
                    <td class="p-2">@hoaDon.LoaiHoaDon</td>
                    <td class="p-2">
                        <span class="badge @(GetBadgeClass(hoaDon.TrangThai))">@hoaDon.TrangThai</span>
                    </td>
                    <td class="p-2 space-x-1">
                        @if (hoaDon.TrangThai == "Chờ xác nhận")
                        {
                            <button @onclick="@(() => XemChiTiet(hoaDon.Id))" class="btn-view">Xem</button>
                            <button @onclick="@(() => CapNhatTrangThai(hoaDon.Id, "Chờ giao"))" class="btn-action">Xác nhận</button>
                            <button @onclick="@(() => HuyDon(hoaDon.Id))" class="btn-danger">Huỷ đơn</button>
                        }
                        else if (hoaDon.TrangThai == "Chờ giao")
                        {
                            <button @onclick="@(() => XemChiTiet(hoaDon.Id))" class="btn-view">Xem</button>
                            <button @onclick="@(() => CapNhatTrangThai(hoaDon.Id, "Vận chuyển"))" class="btn-action">Giao hàng</button>
                            <button @onclick="@(() => HuyDon(hoaDon.Id))" class="btn-danger">Huỷ đơn</button>
                        }
                        else if (hoaDon.TrangThai == "Vận chuyển")
                        {
                            <button @onclick="@(() => XemChiTiet(hoaDon.Id))" class="btn-view">Xem</button>
                            <button @onclick="@(() => CapNhatTrangThai(hoaDon.Id, "Đã giao"))" class="btn-action">Đã giao</button>
                        }
                        else if (hoaDon.TrangThai == "Đã giao")
                        {
                            <button @onclick="@(() => XemChiTiet(hoaDon.Id))" class="btn-view">Xem</button>
                            <button @onclick="@(() => CapNhatTrangThai(hoaDon.Id, "Đã thanh toán"))" class="btn-action">Thanh toán</button>
                        }
                        else if (hoaDon.TrangThai == "Đã thanh toán")
                        {
                            <button @onclick="@(() => XemChiTiet(hoaDon.Id))" class="btn-view">Xem</button>
                            <button @onclick="@(() => CapNhatTrangThai(hoaDon.Id, "hoàn thành"))" class="btn-action">Hoàn thành</button>
                        }
                        else if (hoaDon.TrangThai == "hoàn thành")
                        {
                            <button @onclick="@(() => XemChiTiet(hoaDon.Id))" class="btn-view">Xem</button>
                        }
                        else if (hoaDon.TrangThai == "Đã huỷ")
                        {
                            <span class="text-red-500 italic">Đã huỷ</span>
                        }
                        else
                        {
                            <span class="text-gray-400 italic">---</span>
                        }
                    </td>

                </tr>

                stt++;
            }
        }
        else
        {
            <tr>
                <td colspan="9" class="text-center text-gray-500 p-4">Chưa có dữ liệu</td>
            </tr>
        }
    </tbody>
</table>

@if (showHistory)
{
    <div class="modal-overlay">
        <div class="modal1">
            <!-- Header -->
            <div class="modal-header">
                <h3>Chi tiết đơn hàng #@selectedHoaDon?.Id</h3>
            </div>

            <!-- Thông tin đơn hàng -->
            <div class="order-info-grid">
                <div class="info-card">
                    <h4>Khách hàng</h4>
                    <div class="info-value">
                        @(string.IsNullOrWhiteSpace(selectedHoaDon?.KhachHang?.NguoiDung?.Ten)
                                            ? "Khách lẻ"
                                            : selectedHoaDon.KhachHang.NguoiDung.Ten)
                                                                                 </div>
                                                                                 <div class="info-secondary">
                        @(selectedHoaDon?.KhachHang != null
                                            ? "Khách hàng thành viên"
                                            : "Khách vãng lai")
                </div>
            </div>

                <div class="info-card">
                    <h4>Ngày đặt</h4>
                    <div class="info-value">@selectedHoaDon?.NgayTao.ToString("dd/MM/yyyy")</div>
                    <div class="info-secondary">@selectedHoaDon?.NgayTao.ToString("HH:mm")</div>
                </div>

                <div class="info-card">
                    <h4>Loại đơn hàng</h4>
                    <div class="info-value">@selectedHoaDon?.LoaiHoaDon</div>
                    <div class="info-secondary">
                        @(selectedHoaDon?.LoaiHoaDon == "Online" ? "Đặt hàng trực tuyến" : "Tại quầy")
                    </div>
                </div>

                <div class="info-card">
                    <h4>Trạng thái</h4>
                    <div class="info-value">
                        <span class="badge @(GetBadgeClass(selectedHoaDon?.TrangThai))">
                            @selectedHoaDon?.TrangThai
                        </span>
                    </div>
                </div>
            </div>


            <div class="total-summary">
                <div class="total-amount">@selectedHoaDon?.TongTien.ToString("N0") đ</div>
                <div class="total-label">Tổng giá trị đơn hàng</div>
            </div>

        @if (selectedChiTiet?.Any() == true)
            {
                var tongSoMon = selectedChiTiet.Sum(ct => ct.Soluong);
                <h4 class="section-title">Chi tiết món ăn (@tongSoMon món)</h4>
                <div class="items-list">
                    @foreach (var chiTiet in MonAnTheoLichSu.Values.SelectMany(x => x))
                    {

                        <div class="item-row">
                            <img src="@(string.IsNullOrEmpty(chiTiet.DanhSachAnh?.FirstOrDefault()?.DuongDan)
                                                         ? "/images/default-food.jpg"
                                                         : chiTiet.DanhSachAnh.First().DuongDan)"
                     alt="@chiTiet.ProductId"
                     class="item-image" />

                            <div class="item-info item-info-badges">
                                <div class="item-name">@chiTiet.Ten</div>
                                <div class="item-name">@chiTiet.TheLoai</div>
                                <div class="item-name">@chiTiet.KichCo</div>
                                <div class="item-name">@chiTiet.ChatLieu</div>
                                <div class="item-details">@chiTiet.Mota</div>
                            </div>

                            <div class="item-quantity">x @chiTiet.SoLuongDat</div>
                            <div class="item-price">@chiTiet.Gia.ToString("N0") đ</div>
                        </div>
                        }




                </div>
            }


            <h4 class="section-title">Lịch sử trạng thái</h4>
            @if (selectedLichSu?.Any() == true)
            {
                <div class="history-timeline">
                    @foreach (var lichSu in selectedLichSu.OrderByDescending(ls => ls.ThoiGian))
                    {
                        <div class="history-item">
                            <div class="history-status">@lichSu.TrangThai</div>
                            <div class="history-time">@lichSu.ThoiGian.ToString("dd/MM/yyyy - HH:mm")</div>
                            @if (!string.IsNullOrEmpty(lichSu.LyDo))
                            {
                                <div class="history-reason">@lichSu.LyDo</div>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <div style="font-size: 48px; color: #dee2e6; margin-bottom: 16px;">📋</div>
                    <p>Chưa có lịch sử trạng thái</p>
                </div>
            }

            <button class="btn-close1" @onclick="() => showHistory = false">Đóng</button>
        </div>
    </div>
}




@code {
    private List<HoaDon> DanhSachHoaDon;
    private List<HoaDonChiTietDTO> DanhSachChiTiet;
    private Dictionary<string, List<HoaDonChiTietDTO>> ChiTietTheoHoaDon = new();
    private HoaDon selectedHoaDon;
    private List<HoaDonChiTietDTO> selectedChiTiet;
    private List<ChiTietProductDTO> ChiTietMonAnDTOs = new();
    private string TuKhoa;
    private string TrangThai;
    private readonly List<string> TrangThaiList = new()
    {
        "TẤT CẢ", "Chờ xác nhận", "Chờ giao", "Vận chuyển", "Đã giao", "Đã thanh toán", "Đã huỷ", "hoàn thành"
    };

    protected override async Task OnInitializedAsync()
    {
        await TaiLai();
    }

    private async Task TaiLai()
    {
        var allHoaDon = await ApiService.GetAsync<List<HoaDon>>("HoaDon");
        DanhSachChiTiet = await ApiService.GetAsync<List<HoaDonChiTietDTO>>("HoaDonChiTiet") ?? new();
        

        ChiTietTheoHoaDon = DanhSachChiTiet
            .GroupBy(ct => ct.HoaDonId)
            .ToDictionary(g => g.Key, g => g.ToList());

        DanhSachHoaDon = allHoaDon?
            .Where(hd => string.IsNullOrEmpty(TuKhoa) || hd.KhachHang?.NguoiDung?.Ten.Contains(TuKhoa, StringComparison.OrdinalIgnoreCase) == true)
            .ToList();

        if (!string.IsNullOrEmpty(TrangThai) && TrangThai != "TẤT CẢ")
        {
            DanhSachHoaDon = DanhSachHoaDon
                .Where(hd => hd.TrangThai == TrangThai)
                .ToList();
        }
    }

    private async Task LocTheoTrangThai(string tt)
    {
        TrangThai = tt;
        await TaiLai();
    }

    private string GetBadgeClass(string status) => status switch
    {
        "hoàn thành" => "badge-purple",
        "Chờ xác nhận" => "badge-blue",
        "Chờ giao" => "badge-orange",
        "Vận chuyển" => "badge-blue",
        "Đã giao" => "badge-green",
        "Đã thanh toán" => "badge-green",
        "Đã huỷ" => "badge-red",
        _ => "badge-gray"
    };

    private async Task HuyDon(string hoaDonId)
    {
        bool xacNhan = await JS.InvokeAsync<bool>("confirm", "Bạn có chắc muốn huỷ đơn hàng này không?");
        if (xacNhan)
        {

            var hoaDon = await ApiService.GetbyId<HoaDon , string>( hoaDonId , "HoaDon");
            if (hoaDon != null)
            {
                hoaDon.TrangThai = "Đã huỷ";
                await ApiService.PutAsync<HoaDon>("HoaDon", hoaDon);
                foreach (var item in selectedChiTiet)
                {
                    await HoaDonService.LichSuTrangThai(item.Id, "Đã huỷ", "Bán Hàng Online");
                }
                await TaiLai();
            }
        }
    }

    private async Task CapNhatTrangThai(string hoaDonId, string trangThaiMoi)
    {
        bool xacNhan = await JS.InvokeAsync<bool>("confirm", "Bạn có chắc muốn xác nhận đơn hàng này không?");
        if (!xacNhan) return;

        var hoaDon = await ApiService.GetbyId<HoaDon, string>(hoaDonId, "HoaDon");
        if (hoaDon == null) return;

        selectedChiTiet = await ChiTietHoaDonService.GetChiTiet(hoaDonId);

        if (hoaDon.TrangThai == "Chờ xác nhận" )
        {
            foreach (var item in selectedChiTiet)
            {
                var chiTietMonAnList = await GetChiTietMonAnService.GetAll();
                var monAnChiTiet = chiTietMonAnList.FirstOrDefault(x => x.Id == item.ChiTietMonAnId);
                if (monAnChiTiet == null) continue;

                if (monAnChiTiet.Soluong < item.Soluong)
                {
                    await JS.InvokeVoidAsync("alert", $"Sản phẩm {monAnChiTiet.Ten} không đủ số lượng. Còn {monAnChiTiet.Soluong}, cần {item.Soluong}");
                    return; 
                }

                monAnChiTiet.Soluong -= item.Soluong;
                var updateResult = await ApiService.PutAsync("ChiTietProduct", monAnChiTiet);
                if (!updateResult)
                {
                    await JS.InvokeVoidAsync("alert", $"Cập nhật tồn kho cho {monAnChiTiet.Ten} thất bại!");
                    return;
                }
            }
        }


        hoaDon.TrangThai = trangThaiMoi;
        await ApiService.PutAsync("HoaDon", hoaDon);

        foreach (var item in selectedChiTiet)
        {
            await HoaDonService.LichSuTrangThai(item.Id, trangThaiMoi, "Bán Hàng Online");
        }

        await TaiLai();
    }


    private bool showHistory = false;
    private List<LichSuTrangThai> selectedLichSu = new();

    private Dictionary<Guid, List<ChiTietProductDTO>> MonAnTheoLichSu = new();

    private async Task XemChiTiet(string hoaDonId)
    {
        selectedHoaDon = DanhSachHoaDon.FirstOrDefault(x => x.Id == hoaDonId);

        selectedLichSu = (await HoaDonService.GetLichSu(hoaDonId))
                            ?.OrderByDescending(ls => ls.ThoiGian)
                            .ToList() ?? new();

        selectedChiTiet = await ChiTietHoaDonService.GetChiTiet(hoaDonId);
        var chiTietMonAnList = await GetChiTietMonAnService.GetAll();

        MonAnTheoLichSu.Clear();

        foreach (var hoaDonCt in selectedChiTiet)
        {
            var chiTietMonAn = chiTietMonAnList.FirstOrDefault(ct => ct.Id == hoaDonCt.ChiTietMonAnId);
            if (chiTietMonAn == null) continue;

            chiTietMonAn.SoLuongDat = hoaDonCt.Soluong;

            MonAnTheoLichSu[hoaDonCt.Id] = new List<ChiTietProductDTO> { chiTietMonAn };
        }

        showHistory = true;
    }




}
